{% extends 'base.html' %}
{% set hide_top_nav = true %}
{% block content %}
<div class="max-w-2xl mx-auto mt-10 p-6 bg-white rounded shadow">
  <div class="flex items-center justify-between mb-6">
    <h1 class="text-2xl font-bold">마이페이지</h1>
    <a href="{{ url_for('posts.dashboard') }}" class="px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 font-semibold text-sm">홈으로</a>
  </div>
  <div class="mb-6">
    <div class="flex items-center gap-4 mb-2 justify-between">
      <div class="flex items-center gap-4">
        <div class="w-12 h-12 rounded-full bg-gray-200 flex items-center justify-center text-2xl text-gray-500">
          <i class="fa fa-user"></i>
        </div>
        <div>
          <div class="font-semibold text-lg">{{ user.name if user else '로그인 필요' }}</div>
          <div class="text-gray-500 text-sm">{{ user.email if user else '' }}</div>
        </div>
      </div>
      <a href="{{ url_for('mypage.profile_edit') }}"
         class="px-5 py-3 bg-blue-600 text-white rounded-lg text-base font-bold hover:bg-blue-700 transition-all duration-150"
         style="min-width:120px; text-align:center;">
        개인 정보 변경
      </a>
    </div>
    <div class="text-gray-600 text-sm">가입일: <span>{{ user.created_at if user and user.created_at else '-' }}</span></div>
    <form action="{{ url_for('mypage.user_delete') }}" method="post" class="mt-4">
      <button type="submit" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600" onclick="return confirm('정말로 탈퇴하시겠습니까?\n이 작업은 되돌릴 수 없습니다.');">탈퇴하기</button>
    </form>
  </div>
  <hr class="my-6">
  <h2 class="text-xl font-semibold mb-3 flex items-center gap-3">
    내가 쓴 글
  </h2>
  <form id="multiDeleteForm" action="{{ url_for('mypage.multi_post_delete') }}" method="post">
    {% set page = (request.args.get('page', 1) | int) %}
    {% set per_page = 2 %}
    {% set total = my_posts|length %}
    {% set page_count = (total // per_page) + (1 if total % per_page > 0 else 0) %}
    {% set start = (page-1)*per_page %}
    {% set end = start+per_page %}
    <ul class="space-y-2">
      {% if my_posts and my_posts|length > 0 %}
        {% for post in my_posts[start:end] %}
        <li class="flex items-center gap-3 py-2 px-2 rounded hover:bg-gray-50 transition group">
          <input type="checkbox" name="post_ids" value="{{ post.id }}" class="form-checkbox h-4 w-4 text-blue-600">
          <div class="flex-1 min-w-0">
            <a href="{{ url_for('posts.post_detail', id=post.id) }}" class="font-semibold text-blue-700 hover:underline group-hover:text-blue-900 truncate block">
              {{ post.title }}
            </a>
            <div class="flex items-center gap-3 mt-0.5 text-xs text-gray-500">
              <span>조회수: {{ post.views|int or 0 }}</span>
              {% if post.created_at %}<span>| {{ post.created_at }}</span>{% endif %}
            </div>
          </div>
        </li>
        {% endfor %}
        <li class="mt-3">
          <button type="submit" class="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 text-sm" onclick="return confirm('선택한 글을 모두 삭제하시겠습니까?');">선택 삭제</button>
        </li>
      {% else %}
        <li class="text-gray-400">(여기에 내가 쓴 글 목록이 표시됩니다)</li>
      {% endif %}
    </ul>
    <!-- 게시글 페이지네이션 (이전/다음 버튼 포함) -->
    <div class="flex justify-center gap-2 mt-6">
      {% if page > 1 %}
        <a href="?page={{ page-1 }}" class="px-3 py-1 rounded bg-gray-200 text-gray-800 hover:bg-blue-100">이전</a>
      {% endif %}
      {% for p in range(1, page_count+1) %}
        {% if p >= page-2 and p <= page+2 %}
          {% if p == page %}
            <span class="px-3 py-1 rounded bg-blue-600 text-white font-bold">{{ p }}</span>
          {% else %}
            <a href="?page={{ p }}" class="px-3 py-1 rounded bg-gray-200 text-gray-800 hover:bg-blue-100">{{ p }}</a>
          {% endif %}
        {% elif p == 1 or p == page_count %}
          <a href="?page={{ p }}" class="px-3 py-1 rounded bg-gray-200 text-gray-800 hover:bg-blue-100">{{ p }}</a>
          {% if p == 1 and page > 4 %}<span>...</span>{% endif %}
          {% if p == page_count and page < page_count-3 %}<span>...</span>{% endif %}
        {% endif %}
      {% endfor %}
      {% if page < page_count %}
        <a href="?page={{ page+1 }}" class="px-3 py-1 rounded bg-gray-200 text-gray-800 hover:bg-blue-100">다음</a>
      {% endif %}
    </div>
  </form>
  <hr class="my-6">
  <h2 class="text-xl font-semibold mb-3">내가 쓴 댓글</h2>
  <form id="multiCommentDeleteForm" action="{{ url_for('mypage.multi_comment_delete') }}" method="post">
    <!-- 내가 쓴 댓글 (페이지네이션) -->
    {% set cpage = (request.args.get('cpage', 1) | int) %}
    {% set c_per_page = 3 %}
    {% set c_total = my_comments|length %}
    {% set c_page_count = (c_total // c_per_page) + (1 if c_total % c_per_page > 0 else 0) %}
    {% set c_start = (cpage-1)*c_per_page %}
    {% set c_end = c_start+c_per_page %}
    <ul class="space-y-2">
      {% if my_comments and my_comments|length > 0 %}
        {% for comment in my_comments[c_start:c_end] %}
          <li class="flex items-center gap-2">
            <input type="checkbox" name="comment_ids" value="{{ comment.id }}" class="form-checkbox h-4 w-4 text-blue-600">
            <span class="text-gray-800">{{ comment.content }}</span>
            <!-- <span class="text-xs text-gray-500">{{ comment.created_at }}</span> -->
            {% if comment.post_id %}
              <a href="{{ url_for('posts.post_detail', id=comment.post_id) }}" target="_blank" class="ml-2 px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs hover:bg-blue-200">원문보기</a>
            {% endif %}
          </li>
        {% endfor %}
        <li class="mt-3">
          <button type="submit" class="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 text-sm"
            onclick="return confirm('선택한 댓글을 모두 삭제하시겠습니까?');">선택 삭제</button>
        </li>
      {% else %}
        <li class="text-gray-400">(여기에 내가 쓴 댓글 목록이 표시됩니다)</li>
      {% endif %}
    </ul>
    <!-- 댓글 페이지네이션 (이전/다음 버튼 포함) -->
    <div class="flex justify-center gap-2 mt-6">
      {% if cpage > 1 %}
        <a href="?cpage={{ cpage-1 }}#my-comments" class="px-3 py-1 rounded bg-gray-200 text-gray-800 hover:bg-blue-100">이전</a>
      {% endif %}
      {% for p in range(1, c_page_count+1) %}
        {% if p >= cpage-2 and p <= cpage+2 %}
          {% if p == cpage %}
            <span class="px-3 py-1 rounded bg-blue-600 text-white font-bold">{{ p }}</span>
          {% else %}
            <a href="?cpage={{ p }}#my-comments" class="px-3 py-1 rounded bg-gray-200 text-gray-800 hover:bg-blue-100">{{ p }}</a>
          {% endif %}
        {% elif p == 1 or p == c_page_count %}
          <a href="?cpage={{ p }}#my-comments" class="px-3 py-1 rounded bg-gray-200 text-gray-800 hover:bg-blue-100">{{ p }}</a>
          {% if p == 1 and cpage > 4 %}<span>...</span>{% endif %}
          {% if p == c_page_count and cpage < c_page_count-3 %}<span>...</span>{% endif %}
        {% endif %}
      {% endfor %}
      {% if cpage < c_page_count %}
        <a href="?cpage={{ cpage+1 }}#my-comments" class="px-3 py-1 rounded bg-gray-200 text-gray-800 hover:bg-blue-100">다음</a>
      {% endif %}
    </div>
  </form>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// mypage 체크박스 선택 상태 유지 (localStorage)
const STORAGE_KEY = 'mypage_selected_posts';
function getSelectedIds() {
  try {
    return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
  } catch { return []; }
}
function setSelectedIds(ids) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(ids));
}
function syncCheckboxes() {
  const selected = new Set(getSelectedIds());
  document.querySelectorAll('input[name="post_ids"]').forEach(cb => {
    cb.checked = selected.has(cb.value);
    cb.addEventListener('change', function() {
      let ids = getSelectedIds();
      if (this.checked) {
        if (!ids.includes(this.value)) ids.push(this.value);
      } else {
        ids = ids.filter(id => id !== this.value);
      }
      setSelectedIds(ids);
    });
  });
}
function injectSelectedToForm() {
  const form = document.getElementById('multiDeleteForm');
  if (!form) return;
  let ids = getSelectedIds();
  // 기존 체크박스 모두 해제 후, 선택된 것만 체크
  form.querySelectorAll('input[name="post_ids"]').forEach(cb => {
    cb.checked = ids.includes(cb.value);
  });
  // 선택된 id만 form에 남기기 (submit 시)
  form.addEventListener('submit', function(e) {
    // 체크박스가 페이지에 없을 수도 있으니 hidden input으로 보장
    form.querySelectorAll('input[type="hidden"][name="post_ids"]').forEach(x => x.remove());
    ids.forEach(id => {
      if (!form.querySelector('input[name="post_ids"][value="'+id+'"]')) {
        const hidden = document.createElement('input');
        hidden.type = 'hidden';
        hidden.name = 'post_ids';
        hidden.value = id;
        form.appendChild(hidden);
      }
    });
    // 선택 후 localStorage 초기화
    setSelectedIds([]);
  });
}
// 내가 쓴 댓글 체크박스 선택 상태 유지 (localStorage)
const STORAGE_KEY_COMMENTS = 'mypage_selected_comments';
function getSelectedCommentIds() {
  try {
    return JSON.parse(localStorage.getItem(STORAGE_KEY_COMMENTS) || '[]');
  } catch { return []; }
}
function setSelectedCommentIds(ids) {
  localStorage.setItem(STORAGE_KEY_COMMENTS, JSON.stringify(ids));
}
function syncCommentCheckboxes() {
  const selected = new Set(getSelectedCommentIds());
  document.querySelectorAll('input[name="comment_ids"]').forEach(cb => {
    cb.checked = selected.has(cb.value);
    cb.addEventListener('change', function() {
      let ids = getSelectedCommentIds();
      if (this.checked) {
        if (!ids.includes(this.value)) ids.push(this.value);
      } else {
        ids = ids.filter(id => id !== this.value);
      }
      setSelectedCommentIds(ids);
    });
  });
}
function injectSelectedCommentsToForm() {
  const form = document.getElementById('multiCommentDeleteForm');
  if (!form) return;
  let ids = getSelectedCommentIds();
  // 기존 체크박스 모두 해제 후, 선택된 것만 체크
  form.querySelectorAll('input[name="comment_ids"]').forEach(cb => {
    cb.checked = ids.includes(cb.value);
  });
  // 선택된 id만 form에 남기기 (submit 시)
  form.addEventListener('submit', function(e) {
    // 체크박스가 페이지에 없을 수도 있으니 hidden input으로 보장
    form.querySelectorAll('input[type="hidden"][name="comment_ids"]').forEach(x => x.remove());
    ids.forEach(id => {
      if (!form.querySelector('input[name="comment_ids"][value="'+id+'"]')) {
        const hidden = document.createElement('input');
        hidden.type = 'hidden';
        hidden.name = 'comment_ids';
        hidden.value = id;
        form.appendChild(hidden);
      }
    });
    // 선택 후 localStorage 초기화
    setSelectedCommentIds([]);
  });
}

// 체크박스 상태 복원 및 이벤트 바인딩을 항상 보장
document.addEventListener('DOMContentLoaded', function() {
  syncCheckboxes();
  injectSelectedToForm();
  syncCommentCheckboxes();
  injectSelectedCommentsToForm();
});
</script>
{% endblock %}
