{% extends 'base.html' %}
{% block content %}
<script>
  window.addEventListener('pageshow', function (e) {
    if (e.persisted) {
      window.location.reload();
    }
  });
</script>
<h1 class="text-xl font-semibold mb-4">글 상세</h1>

<div class="space-y-4">
  <div>
    <label class="block text-sm text-gray-500">카테고리</label>
    <div class="w-full border rounded px-3 py-2 bg-gray-100">{{ post.category }}</div>
  </div>
  <div>
    <label class="block text-sm text-gray-500">제목</label>
    <div class="w-full border rounded px-3 py-2 bg-gray-100 font-semibold">{{ post.title }}</div>
  </div>
  <div>
    <label class="block text-sm text-gray-500">미리보기</label>
    {% if meta and (meta.title or meta.description or meta.image) %}
      <a href="{{ post.url }}" target="_blank" rel="noreferrer noopener" class="block border rounded overflow-hidden bg-white hover:bg-gray-50">
        {% if meta.image %}
          <img src="{{ meta.image }}" alt="preview" class="w-full max-h-64 object-cover" />
        {% endif %}
        <div class="p-3">
          <div class="text-xs text-gray-500">{{ meta.site_name or post.url }}</div>
          <div class="font-semibold">{{ meta.title or '-' }}</div>
          <div class="text-sm text-gray-700 line-clamp-2" style="display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden">{{ meta.description or '' }}</div>
        </div>
      </a>
    {% elif post.url %}
      <a href="{{ post.url }}" target="_blank" rel="noreferrer noopener" class="text-blue-600 break-all">{{ post.url }}</a>
    {% else %}
      <div class="text-gray-500">URL 없음</div>
    {% endif %}
  </div>
  <div>
    <label class="block text-sm text-gray-500">내용</label>
    <div class="w-full border rounded px-3 py-2 bg-gray-100 whitespace-pre-wrap">{{ post.contents }}</div>
    <div class="text-xs text-gray-500 mt-1">{{ post.date_text }}</div>
  </div>

  <div class="flex items-center gap-4 mt-4">
    {% if current_user %}
      <button id="likeBtn" class="px-4 py-2 rounded text-sm {{ 'bg-emerald-600 text-white' if is_liked else 'bg-gray-200 text-gray-800' }}">
        추천 <span id="likeCount">{{ post.like_count }}</span>
      </button>
    {% else %}
      <div class="px-4 py-2 rounded text-sm bg-gray-200 text-gray-800">
        추천 {{ post.like_count }}
      </div>
    {% endif %}
    
    {% if post.author %}
      <div class="flex items-center gap-2">
        <span class="text-sm text-gray-600">작성자: {{ post.author.name }}</span>
        {% if current_user and current_user.id != post.author.id %}
          <button id="subscribeBtn" class="px-3 py-1 rounded text-xs {{ 'bg-blue-600 text-white' if is_subscribed else 'bg-gray-200 text-gray-800' }}">
            {{ '구독중' if is_subscribed else '구독하기' }}
          </button>
        {% endif %}
      </div>
    {% endif %}
  </div>

  <div class="flex gap-2 mt-4">
    <a href="{{ url_for('root') }}" class="px-3 py-2 bg-gray-200 text-gray-800 rounded text-sm">목록</a>
    {% if current_user and current_user.id == post.author.id %}
    <a href="{{ url_for('post_edit_get', id=post.id) }}" class="px-3 py-2 bg-blue-600 text-white rounded text-sm">수정</a>
    <form action="{{ url_for('post_delete', id=post.id) }}" method="post" onsubmit="return confirm('삭제하시겠습니까?');">
      <button class="px-3 py-2 bg-red-600 text-white rounded text-sm">삭제</button>
    </form>
    {% endif %}
  </div>
  
  <!-- 댓글 영역 시작 -->
  <div class="mt-8">
    <div id="bestCommentsArea">
      {% if best_comments and best_comments|length > 0 %}
        <div class="mb-6">
          <h2 class="text-lg font-bold text-emerald-700 mb-2">베스트 댓글</h2>
          <div class="space-y-2">
            {% for c in best_comments %}
            <div class="border rounded px-3 py-2 bg-yellow-50 flex justify-between items-center">
              <div>
                <span class="font-semibold">{{ c.user_name }}</span>
                <span class="text-xs text-gray-500 ml-2">{{ c.created_at }}</span>
                <div class="mt-1">{{ c.content }}</div>
              </div>
              <span class="text-emerald-600 font-bold text-sm">추천 수 {{ c.like_count }}</span>
            </div>
            {% endfor %}
          </div>
        </div>
      {% endif %}
    </div>
    <h2 class="text-lg font-semibold mb-3">댓글</h2>
    <!-- 댓글 작성 폼 (로그인 사용자만) -->
    {% if current_user %}
    <form id="commentForm" action="{{ url_for('post_comments', id=post.id) }}" method="post" class="flex gap-2 mb-4">
      <input type="text" name="content" required maxlength="200" placeholder="댓글을 입력하세요" class="flex-1 border rounded px-3 py-2" />
      <button type="submit" class="bg-emerald-600 text-white px-4 py-2 rounded">등록</button>
    </form>
    {% endif %}
    <!-- 댓글 리스트 -->
    <div id="commentList" class="space-y-3">
      {% for c in comments %}
      <div class="border rounded px-3 py-2 bg-white flex justify-between items-center">
        <div>
          <span class="font-semibold">{{ c.user_name }}</span>
          <span class="text-xs text-gray-500 ml-2">{{ c.created_at }}</span>
          <div class="mt-1">{{ c.content }}</div>
          <!-- 추천 버튼 및 추천수 -->
          <button type="button"
                  class="text-emerald-600 text-xs px-2 py-1 rounded border"
                  data-cid="{{ c.id }}"
                  onclick="likeComment(this.dataset.cid, this)">
            추천
          </button>
          <span class="ml-1 text-xs text-gray-700" id="like-count-{{ c.id }}">{{ c.like_count or 0 }}</span>
        </div>
        {% if current_user and c.user_id == current_user.id %}
        <form action="{{ url_for('comment_delete', comment_id=c.id) }}" method="post">
          <button class="text-red-600 text-xs px-2 py-1 rounded">삭제</button>
        </form>
        {% endif %}
      </div>
      {% else %}
      <div class="text-gray-500">아직 댓글이 없습니다.</div>
      {% endfor %}
    </div>
  </div>
  <!-- 댓글 영역 끝 -->
</div>

<script>
const likeBtn = document.getElementById('likeBtn');
if (likeBtn) {
  likeBtn.addEventListener('click', () => {
    fetch("{{ url_for('post_like', id=post.id) }}", {
      method: 'POST',
      headers: { 'X-Requested-With': 'XMLHttpRequest' },
      credentials: 'same-origin'
    })
    .then(res => res.json())
    .then(data => {
      if (data.ok) {
        document.getElementById('likeCount').textContent = data.like_count;
        if (data.action === 'liked') {
          likeBtn.classList.remove('bg-gray-200', 'text-gray-800');
          likeBtn.classList.add('bg-emerald-600', 'text-white');
        } else {
          likeBtn.classList.remove('bg-emerald-600', 'text-white');
          likeBtn.classList.add('bg-gray-200', 'text-gray-800');
        }
      } else {
        alert(data.message || '오류가 발생했습니다.');
      }
    });
  });
}

const subscribeBtn = document.getElementById('subscribeBtn');
if (subscribeBtn) {
  subscribeBtn.addEventListener('click', () => {
    fetch("{{ url_for('user_subscribe', id=post.author.id) }}", {
      method: 'POST',
      headers: { 'X-Requested-With': 'XMLHttpRequest' },
      credentials: 'same-origin'
    })
    .then(res => res.json())
    .then(data => {
      if (data.ok) {
        if (data.action === 'subscribed') {
          subscribeBtn.textContent = '구독중';
          subscribeBtn.classList.remove('bg-gray-200', 'text-gray-800');
          subscribeBtn.classList.add('bg-blue-600', 'text-white');
        } else {
          subscribeBtn.textContent = '구독하기';
          subscribeBtn.classList.remove('bg-blue-600', 'text-white');
          subscribeBtn.classList.add('bg-gray-200', 'text-gray-800');
        }
      } else {
        alert(data.message || '오류가 발생했습니다.');
      }
    });
  });
}

function likeComment(commentId, btn) {
  fetch('/like/' + commentId + '/comment', {
    method: 'POST',
    headers: {
      'X-Requested-With': 'XMLHttpRequest'
    },
    credentials: 'same-origin'
  })
  .then(res => res.json())
  .then(data => {
    if (data.ok) {
      document.getElementById('like-count-' + commentId).textContent = data.like_count;
      btn.blur();
      // 베스트 댓글 영역 갱신
      if (data.best_comments_html !== undefined) {
        document.getElementById('bestCommentsArea').innerHTML = data.best_comments_html;
      }
    } else {
      alert(data.message || '오류');
    }
  })
  .catch(() => alert('오류가 발생했습니다.'));
}

// 댓글 등록 AJAX
const commentForm = document.getElementById('commentForm');
if (commentForm) {
  commentForm.addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(commentForm);
    fetch(commentForm.action, {
      method: 'POST',
      headers: {
        'X-Requested-With': 'XMLHttpRequest'
      },
      body: formData,
      credentials: 'same-origin'
    })
    .then(res => res.json())
    .then(data => {
      if (data.ok) {
        // 새 댓글을 댓글 리스트 맨 위에 추가
        const commentList = document.getElementById('commentList');
        if (commentList && data.comment_html) {
          commentList.insertAdjacentHTML('afterbegin', data.comment_html);
        }
        // 베스트 댓글 영역 갱신
        if (data.best_comments_html !== undefined) {
          document.getElementById('bestCommentsArea').innerHTML = data.best_comments_html;
        }
        commentForm.reset();
        setupCommentDeleteAjax(); // 새 댓글에도 삭제 바인딩
      } else {
        alert(data.message || '댓글 등록 오류');
      }
    })
    .catch(() => alert('댓글 등록 중 오류가 발생했습니다.'));
  });
}

// 댓글 삭제 AJAX
function setupCommentDeleteAjax() {
  document.querySelectorAll('#commentList form[action^="/delete/"]').forEach(form => {
    // 기존 onsubmit 속성 제거 (중복 confirm 방지)
    form.onsubmit = null;
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      if (!confirm('댓글을 삭제하시겠습니까?')) return;
      fetch(form.action, {
        method: 'POST',
        headers: { 'X-Requested-With': 'XMLHttpRequest' },
        credentials: 'same-origin'
      })
      .then(res => res.json())
      .then(data => {
        if (data.ok) {
          // 해당 댓글 DOM 제거
          const commentDiv = form.closest('.border.rounded.px-3.py-2.bg-white.flex');
          if (commentDiv) commentDiv.remove();
          // 베스트 댓글 영역 갱신
          if (data.best_comments_html !== undefined) {
            document.getElementById('bestCommentsArea').innerHTML = data.best_comments_html;
          }
        } else {
          alert(data.message || '댓글 삭제 오류');
        }
      })
      .catch(() => alert('댓글 삭제 중 오류가 발생했습니다.'));
    });
  });
}
// 댓글 등록/삭제 후에도 항상 바인딩
setupCommentDeleteAjax();
</script>
{% endblock %}