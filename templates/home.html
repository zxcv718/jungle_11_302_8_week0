{% extends 'base.html' %}
{% block content %}

<div class="flex flex-row gap-8">
  <div class="w-full {% if user_info %}md:w-2/3{% endif %}">
    <!-- Post Carousel Section -->
    <section class="mt-4">
      <div class="max-w-lg">
        <h2 class="text-xl font-semibold mb-4">인기 글</h2>
        <div id="carousel-container" class="relative bg-white rounded-lg border shadow-sm overflow-hidden">
          <!-- Carousel slides -->
          <div id="carousel-slides" class="flex transition-transform duration-500 ease-in-out">
            {% for post in popular_posts %}
            <div class="w-full flex-shrink-0">
              <a href="{{ url_for('posts.post_detail', id=post.id) }}" class="block relative h-72 bg-gray-200 text-white">
                {% if post.meta and post.meta.image %}
                <img src="{{ post.meta.image }}" alt="{{ post.title }}" class="w-full h-full object-cover" />
                {% endif %}
                <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent"></div>
                <div class="absolute bottom-0 left-0 right-0 p-4 pl-16 pb-24">
                  <h3 class="font-bold truncate text-3xl">{{ post.title or '' }}</h3>
                </div>
              </a>
            </div>
            {% endfor %}
          </div>

          <!-- Prev/Next Buttons -->
          <button id="carousel-prev" class="absolute top-1/2 left-2 transform -translate-y-1/2 bg-gray-800 bg-opacity-50 text-white rounded-full p-2 hover:bg-opacity-75 focus:outline-none">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
          </button>
          <button id="carousel-next" class="absolute top-1/2 right-2 transform -translate-y-1/2 bg-gray-800 bg-opacity-50 text-white rounded-full p-2 hover:bg-opacity-75 focus:outline-none">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
          </button>

          <!-- Indicators -->
          <div id="carousel-indicators" class="absolute bottom-4 left-1/2 transform -translate-x-1/2 flex space-x-2">
            {% for post in popular_posts %}
            <button data-index="{{ loop.index0 }}" class="w-3 h-3 rounded-full {% if loop.first %}bg-gray-800{% else %}bg-gray-300{% endif %}"></button>
            {% endfor %}
          </div>
        </div>
      </div>
    </section>

    <section class="mt-8">
      <div class="max-w-4xl mx-auto">
        <h1 class="text-2xl font-bold">전체 글 목록</h1>
      </div>

      <div class="mt-4 space-y-4 max-w-lg">
        {% if posts %}
          {% for post in posts %}
            <a href="{{ url_for('posts.post_detail', id=post.id) }}" class="block p-4 bg-white rounded border hover:bg-gray-50">
              <div class="flex justify-between items-center text-sm text-gray-500 mb-1">
                <span>{{ post.category or '' }} · {{ post.date_text or '' }}</span>
                <span class="font-semibold text-emerald-600">추천 {{ post.like_count }}</span>
              </div>
              <div class="font-semibold text-gray-900 line-clamp-1">{{ post.title or '' }}</div>
              <div class="text-gray-700 mt-1 line-clamp-2">{{ post.contents or '' }}</div>
            </a>
          {% endfor %}
        {% else %}
          <div class="mt-8 text-center text-gray-500">작성된 글이 없습니다.</div>
        {% endif %}
      </div>
    </section>
  </div>

  {% if user_info %}
  <div class="hidden md:block md:w-1/3">
    <aside class="sticky top-8">
        <h2 class="text-xl font-semibold mb-4">구독한 글</h2>
        <div class="space-y-4">
            {% if subscribed_posts %}
                {% for post in subscribed_posts %}
                    <a href="{{ url_for('posts.post_detail', id=post.id) }}" class="block p-4 bg-white rounded border hover:bg-gray-50">
                      <div class="text-sm text-gray-500 mb-1">{{ post.date_text or '' }}</div>
                      <div class="font-semibold text-gray-900 line-clamp-1">{{ post.title or '' }}</div>
                    </a>
                {% endfor %}
            {% else %}
                <div class="text-center text-gray-500">구독한 글이 없습니다.</div>
            {% endif %}
        </div>
    </aside>
  </div>
  {% endif %}
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const carouselContainer = document.getElementById('carousel-container');
    if (!carouselContainer) return;

    const carouselSlides = document.getElementById('carousel-slides');
    const carouselPrev = document.getElementById('carousel-prev');
    const carouselNext = document.getElementById('carousel-next');
    const carouselIndicators = document.getElementById('carousel-indicators');
    
    const slides = carouselSlides.querySelectorAll('.w-full.flex-shrink-0');
    const indicators = carouselIndicators.querySelectorAll('button');
    const numSlides = slides.length;
    
    if (numSlides === 0) {
      carouselContainer.style.display = 'none';
      return;
    }

    let currentIndex = 0;
    let carouselInterval = null;

    function updateCarousel() {
      carouselSlides.style.transform = `translateX(-${currentIndex * 100}%)`;
      indicators.forEach((indicator, index) => {
        indicator.classList.toggle('bg-gray-800', index === currentIndex);
        indicator.classList.toggle('bg-gray-300', index !== currentIndex);
      });
    }

    function resetCarouselInterval() {
      clearInterval(carouselInterval);
      if (numSlides > 1) {
        carouselInterval = setInterval(() => {
          currentIndex = (currentIndex + 1) % numSlides;
          updateCarousel();
        }, 3000);
      }
    }

    carouselPrev.addEventListener('click', () => {
      if (numSlides === 0) return;
      currentIndex = (currentIndex - 1 + numSlides) % numSlides;
      updateCarousel();
      resetCarouselInterval();
    });

    carouselNext.addEventListener('click', () => {
      if (numSlides === 0) return;
      currentIndex = (currentIndex + 1) % numSlides;
      updateCarousel();
      resetCarouselInterval();
    });

    carouselIndicators.addEventListener('click', (e) => {
      if (e.target.tagName === 'BUTTON') {
        currentIndex = parseInt(e.target.dataset.index, 10);
        updateCarousel();
        resetCarouselInterval();
      }
    });

    // Initial setup
    updateCarousel();
    resetCarouselInterval();
  });

  // This utility function might be used elsewhere, so it's safer to keep it.
  async function fetchWithAutoRefresh(url, options={}) {
    const loginUrl = "{{ url_for('auth.login_get') }}";
    const refreshUrl = "{{ url_for('auth.refresh') }}";
    const res = await fetch(url, { credentials: 'same-origin', ...options });
    if (res.status !== 401) return res;
    let err;
    try { err = await res.json(); } catch {}
    const code = err && err.error;
    if (code === 'access_expired' || code === 'unauthorized' || code === 'invalid_token') {
      const r = await fetch(refreshUrl, { method: 'POST', credentials: 'same-origin' });
      if (r.ok) {
        return fetch(url, { credentials: 'same-origin', ...options });
      }
      try {
        const e = await r.json();
        if (e && e.error === 'refresh_expired') {
          alert('세션이 만료되었습니다. 다시 로그인해주세요.');
          window.location.href = loginUrl;
          return Promise.reject(new Error('refresh_expired'));
        }
      } catch {}
      alert('인증이 필요합니다. 다시 로그인해주세요.');
      window.location.href = loginUrl;
      return Promise.reject(new Error('unauthorized'));
    }
    return res;
  }
</script>
{% endblock %}