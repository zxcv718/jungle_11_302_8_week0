{% extends 'base.html' %}
{% block content %}
<div class="max-w-xl mx-auto">
<h1 class="text-xl font-semibold mb-4">회원가입</h1>
<form id="registerForm" action="{{ url_for('register_post') }}" method="post" class="space-y-4">
  <div>
    <label class="block text-sm">이름</label>
    <input id="name" type="text" name="name" required class="w-full border rounded px-3 py-2" />
  </div>
  <div>
    <label class="block text-sm">이메일</label>
    <div class="relative">
      <input id="email" type="email" name="email" required class="w-full border rounded px-3 py-2 pr-24" />
      <span id="emailStatus" class="absolute right-2 top-2 text-sm"></span>
    </div>
    <p id="emailHelp" class="text-xs text-gray-500 mt-1">이메일 형식 확인 및 중복 여부를 검사합니다.</p>
  </div>
  <div>
    <label class="block text-sm">비밀번호</label>
    <input id="password" type="password" name="password" required minlength="6" class="w-full border rounded px-3 py-2" />
    <p class="text-xs text-gray-500 mt-1">6자 이상 입력하세요.</p>
  </div>
  <div>
    <label class="block text-sm">비밀번호 확인</label>
    <input id="password_confirm" type="password" name="password_confirm" required minlength="6" class="w-full border rounded px-3 py-2" />
    <p id="pwMatch" class="text-xs mt-1"></p>
  </div>
  <button id="submitBtn" type="submit" class="w-full bg-emerald-600 text-white py-2 rounded opacity-50 cursor-not-allowed" disabled>회원가입</button>
</form>
<p class="mt-4 text-sm">이미 계정이 있나요? <a href="{{ url_for('login_get') }}" class="text-blue-600">로그인</a></p>

</div>

<script>
  const email = document.getElementById('email');
  const nameInput = document.getElementById('name');
  const pw = document.getElementById('password');
  const pw2 = document.getElementById('password_confirm');
  const emailStatus = document.getElementById('emailStatus');
  const pwMatch = document.getElementById('pwMatch');
  const submitBtn = document.getElementById('submitBtn');

  let emailOk = false;
  let pwOk = false;

  async function checkEmailDuplication(value) {
    if (!value || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value)) {
      emailStatus.textContent = '';
      emailOk = false;
      updateSubmitState();
      return;
    }
    emailStatus.textContent = '확인 중...';
    try {
      const res = await fetch(`{{ url_for('api_check_email') }}?email=${encodeURIComponent(value)}`);
      const data = await res.json();
      if (data.exists) {
        emailStatus.textContent = '이미 사용 중';
        emailStatus.className = 'absolute right-2 top-2 text-xs text-red-600';
        emailOk = false;
      } else {
        emailStatus.textContent = '사용 가능';
        emailStatus.className = 'absolute right-2 top-2 text-xs text-green-600';
        emailOk = true;
      }
    } catch (e) {
      emailStatus.textContent = '오류';
      emailStatus.className = 'absolute right-2 top-2 text-xs text-red-600';
      emailOk = false;
    }
    updateSubmitState();
  }

  function validatePasswords() {
    const v1 = pw.value;
    const v2 = pw2.value;
    if (!v1 || !v2) {
      pwMatch.textContent = '';
      pwMatch.className = 'text-xs mt-1';
      pwOk = false;
    } else if (v1.length < 6) {
      pwMatch.textContent = '비밀번호는 6자 이상이어야 합니다.';
      pwMatch.className = 'text-xs mt-1 text-red-600';
      pwOk = false;
    } else if (v1 !== v2) {
      pwMatch.textContent = '비밀번호가 일치하지 않습니다.';
      pwMatch.className = 'text-xs mt-1 text-red-600';
      pwOk = false;
    } else {
      pwMatch.textContent = '비밀번호가 일치합니다.';
      pwMatch.className = 'text-xs mt-1 text-green-600';
      pwOk = true;
    }
    updateSubmitState();
  }

  function updateSubmitState() {
    const nameOk = !!nameInput.value.trim();
    const allOk = nameOk && emailOk && pwOk;
    submitBtn.disabled = !allOk;
    submitBtn.className = 'w-full bg-emerald-600 text-white py-2 rounded ' + (allOk ? '' : 'opacity-50 cursor-not-allowed');
  }

  email.addEventListener('input', (e) => {
    const value = e.target.value.trim();
    // 디바운스 간단 처리
    clearTimeout(email._t);
    email._t = setTimeout(() => checkEmailDuplication(value), 300);
  });
  pw.addEventListener('input', validatePasswords);
  pw2.addEventListener('input', validatePasswords);
  nameInput.addEventListener('input', updateSubmitState);

  // 초기 상태 설정
  updateSubmitState();
</script>
{% endblock %}
